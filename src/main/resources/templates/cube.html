<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Cube 시뮬레이션</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<main>
    <aside>
        <h3>통계</h3>
        <p>잠재능력 재설정: <span id="stat-default-count">0</span>회</p>
        <p>에디셔널 재설정: <span id="stat-additional-count">0</span>회</p>
        <p>잠재능력 재설정 비용: <span id="stat-default-cost">0</span>메소</p>
        <p>에디셔널 재설정 비용: <span id="stat-additional-cost">0</span>메소</p>
        <p>총 비용: <span id="stat-total-cost">0</span>메소</p>
    </aside>
    <!-- 기본 큐브 -->
    <p>
        큐브 등급: <span id="grade">RARE</span>
        <span id="default-count" style="color: #555; font-size: 0.9rem;">(0 / 10)</span>
    </p>
    <table id="default-table">
        <tr><th>잠재옵션</th></tr>
        <tr><td>-</td></tr>
        <tr><td>-</td></tr>
        <tr><td>-</td></tr>
    </table>

    <!-- 에디셔널 큐브 -->
    <p>
        에디셔널 큐브 등급: <span id="additional-grade">RARE</span>
        <span id="additional-count" style="color: #555; font-size: 0.9rem;">(0 / 31)</span>
    </p>
    <table id="additional-table">
        <tr><th>에디셔널 잠재옵션</th></tr>
        <tr><td>-</td></tr>
        <tr><td>-</td></tr>
        <tr><td>-</td></tr>
    </table>

    <div class="cube-btn-group">
        <button id="default-btn" class="cube-btn">잠재능력 재설정</button>
        &nbsp;&nbsp;&nbsp;
        <button id="additional-btn" class="cube-btn">에디셔널 재설정</button>
    </div>
    <div class="cube-btn-group">
        <button id="reset-btn" class="cube-btn">초기화</button>
    </div>
</main>

<script>
    const limitMap = {
        DEFAULT_RARE: 10,
        DEFAULT_EPIC: 42,
        DEFAULT_UNIQUE: 102,
        ADDITIONAL_RARE: 31,
        ADDITIONAL_EPIC: 76,
        ADDITIONAL_UNIQUE: 214,
        LEGENDARY: 0
    };

    async function rollCube(url, tableId, gradeId, countId) {
        const res = await fetch(url);
        const data = await res.json();
        const potential = data.potential;
        const statistics = data.statistics;

        // 등급 업데이트
        document.getElementById(gradeId).textContent = potential.grade;

        // limitMap 키 조합: 기본/에디셔널 + 등급
        const typePrefix = potential.type === 'ADDITIONAL' ? 'ADDITIONAL_' : 'DEFAULT_';
        const limitKey = typePrefix + potential.grade;
        const limit = limitMap[limitKey] || 0;

        // 천장 카운트 업데이트
        document.getElementById(countId).textContent =
            `(${limit === 0 ? '-' : potential.count} / ${limit === 0 ? '-' : limit})`;

        // 옵션 테이블 초기화
        const table = document.getElementById(tableId);
        table.innerHTML = tableId === 'default-table'
            ? '<tr><th>잠재옵션</th></tr>'
            : '<tr><th>에디셔널 잠재옵션</th></tr>';

        // 옵션 추가
        potential.options.forEach(opt => {
            const row = table.insertRow();
            const cell = row.insertCell();
            cell.textContent = opt.name;
        });

        if (statistics) {
            document.getElementById('stat-default-count').textContent = statistics.defaultCount;
            document.getElementById('stat-additional-count').textContent = statistics.additionalCount;
            document.getElementById('stat-default-cost').textContent = statistics.defaultCost;
            document.getElementById('stat-additional-cost').textContent = statistics.additionalCost;
            document.getElementById('stat-total-cost').textContent = statistics.totalCost;
        }
    }

    document.getElementById('default-btn').addEventListener('click', () => {
        rollCube('/cube/use', 'default-table', 'grade', 'default-count');
    });

    document.getElementById('additional-btn').addEventListener('click', () => {
        rollCube('/cube/use/additional', 'additional-table', 'additional-grade', 'additional-count');
    });

    document.getElementById('reset-btn').addEventListener('click', async () => {
        const res = await fetch('/cube/reset');
        const data = await res.json();
        const potential = data.potential;
        const statistics = data.statistics;

        // 등급 초기화
        document.getElementById('grade').textContent = potential.grade;
        document.getElementById('additional-grade').textContent = potential.grade;

        // 천장 카운트 초기화
        document.getElementById('default-count').textContent = '(0 / 10)';
        document.getElementById('additional-count').textContent = '(0 / 31)';

        // 통계 초기화
        if (statistics) {
            document.getElementById('stat-default-count').textContent = statistics.defaultCount;
            document.getElementById('stat-additional-count').textContent = statistics.additionalCount;
            document.getElementById('stat-default-cost').textContent = statistics.defaultCost;
            document.getElementById('stat-additional-cost').textContent = statistics.additionalCost;
            document.getElementById('stat-total-cost').textContent = statistics.totalCost;
        }

        // 테이블 초기화
        ['default-table', 'additional-table'].forEach(id => {
            const table = document.getElementById(id);
            table.innerHTML = id === 'default-table'
                ? '<tr><th>잠재옵션</th></tr>'
                : '<tr><th>에디셔널 잠재옵션</th></tr>';

            for (let i = 0; i < 3; i++) {
                const row = table.insertRow();
                const cell = row.insertCell();
                cell.textContent = '-';
            }
        });
    });
</script>

<div th:replace="~{fragments/footer :: footer}"></div>

</body>
</html>
