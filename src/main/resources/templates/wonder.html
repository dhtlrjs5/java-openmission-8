<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ìœ„ìŠµì˜ ì›ë”ë² ë¦¬ ì‹œë®¬ë ˆì´ì…˜</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <style>
        /* CSSëŠ” ê¸°ì¡´ common.cssë¥¼ ì‚¬ìš©í•˜ê³ , ë ˆì´ì•„ì›ƒì€ inline styleë¡œ ì¡°ì • */
        .stats-header, .item-counts-box { border: 1px solid #ccc; border-radius: 8px; }
        .stats-header { background-color: #f8f8f8; }
        .item-counts-box { background-color: white; }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<div id="draw-effect-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 1000; justify-content: center; align-items: center;">

    <img id="effect-stage1-gif" th:src="@{/pet/using.gif}" style="width: 700px; height: 700px; position: absolute;">

    <div id="effect-stage2-reveal" style="display: none; text-align: center;">

        <img th:src="@{/pet/result.gif}" alt="Reveal Frame" style="width: 700px; height: 700px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">

        <img id="effect-item-image" src="" alt="Drawn Item Image" style="width: 40px; height: 40px; position: absolute; top: 52%; left: 50%; transform: translate(-50%, -50%); border-radius: 10px;">

        <p id="effect-item-name" style="position: absolute; top: 70%; left: 50%; transform: translateX(-50%); color: white; font-size: 32px; font-weight: 900; text-shadow: 0 0 10px black;"></p>

        <button id="close-effect-btn" style="position: absolute; top: 85%; left: 50%; transform: translateX(-50%); padding: 10px 30px; background-color: #f39c12; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 18px;">ë‹«ê¸°</button>

    </div>
</div>

<main style="text-align: center; margin-top: 40px;">
    <h2>ğŸ² ìœ„ìŠµì˜ ì›ë”ë² ë¦¬ ì‹œë®¬ë ˆì´í„°</h2>

    <div class="stats-header" style="margin: 20px auto; padding: 15px; width: 600px; display: flex; justify-content: space-around;">
        <div style="font-size: 1.1rem; font-weight: bold;">ì‚¬ìš©ê°œìˆ˜: <span id="stat-count">0</span>ê°œ</div>
        <div style="font-size: 1.1rem; font-weight: bold; color: #4CAF50;">ëˆ„ì ê¸ˆì•¡: <span id="stat-cost">0</span>ì›</div>
    </div>

    <div class="item-counts-box" style="margin: 20px auto; padding: 20px; width: 600px; text-align: left;">

        <h3 style="margin-top: 0; text-align: center;">ì•„ì´í…œ íšë“ í†µê³„</h3>

        <div style="display: flex; justify-content: space-around; margin-bottom: 10px; text-align: center;">
            <div class="item-stat-wrapper">
                <img th:src="@{/pet/í¬ë¦¼.gif}" alt="í¬ë¦¼ ì•„ì´ì½˜" style="width: 32px; height: 32px; display: block; margin: 0 auto 5px auto;">
                <div style="font-weight: bold; color: #DAA520;">í¬ë¦¼: <span id="item-í¬ë¦¼">0</span>íšŒ</div>
            </div>
            <div class="item-stat-wrapper">
                <img th:src="@{/pet/ìƒ¤ìƒ¤.gif}" alt="ìƒ¤ìƒ¤ ì•„ì´ì½˜" style="width: 32px; height: 32px; display: block; margin: 0 auto 5px auto;">
                <div style="font-weight: bold; color: #DAA520;">ìƒ¤ìƒ¤: <span id="item-ìƒ¤ìƒ¤">0</span>íšŒ</div>
            </div>
            <div class="item-stat-wrapper">
                <img th:src="@{/pet/íŒ¬ë””.gif}" alt="íŒ¬ë”” ì•„ì´ì½˜" style="width: 32px; height: 32px; display: block; margin: 0 auto 5px auto;">
                <div style="font-weight: bold; color: #DAA520;">íŒ¬ë””: <span id="item-íŒ¬ë””">0</span>íšŒ</div>
            </div>
        </div>

        <hr style="border-top: 1px dashed #eee;">

        <div style="display: flex; justify-content: space-around; margin-bottom: 10px; text-align: center;">
            <div class="item-stat-wrapper">
                <img th:src="@{/pet/ê³ ë†ì¶•í”„ë¦¬ë¯¸ì—„ìƒëª…ì˜ë¬¼.gif}" alt="ìƒëª…ì˜ ë¬¼ ì•„ì´ì½˜" style="width: 32px; height: 32px; display: block; margin: 0 auto 5px auto;">
                <div>ê³ ë†ì¶• í”„ë¦¬ë¯¸ì—„ ìƒëª…ì˜ ë¬¼: <span id="item-ê³ ë†ì¶•í”„ë¦¬ë¯¸ì—„ìƒëª…ì˜ë¬¼">0</span>íšŒ</div>
            </div>
            <div class="item-stat-wrapper">
                <img th:src="@{/pet/ì˜¤ê°€ë‹‰ì›ë”ì¿ í‚¤.gif}" alt="ì›ë” ì¿ í‚¤ ì•„ì´ì½˜" style="width: 32px; height: 32px; display: block; margin: 0 auto 5px auto;">
                <div>ì˜¤ê°€ë‹‰ ì›ë” ì¿ í‚¤: <span id="item-ì˜¤ê°€ë‹‰ì›ë”ì¿ í‚¤">0</span>íšŒ</div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-around; text-align: center;">
            <div class="item-stat-wrapper">
                <img th:src="@{/pet/ì‹ë¹µì´.gif}" alt="ì‹ë¹µì´ ì•„ì´ì½˜" style="width: 32px; height: 32px; display: block; margin: 0 auto 5px auto;">
                <div>ì‹ë¹µì´: <span id="item-ì‹ë¹µì´">0</span>íšŒ</div>
            </div>
            <div class="item-stat-wrapper">
                <img th:src="@{/pet/ë¹µë‘˜ê¸°.gif}" alt="ë¹µë‘˜ê¸° ì•„ì´ì½˜" style="width: 32px; height: 32px; display: block; margin: 0 auto 5px auto;">
                <div>ë¹µë‘˜ê¸°: <span id="item-ë¹µë‘˜ê¸°">0</span>íšŒ</div>
            </div>
            <div class="item-stat-wrapper">
                <img th:src="@{/pet/ì œí‚¤.gif}" alt="ì œí‚¤ ì•„ì´ì½˜" style="width: 32px; height: 32px; display: block; margin: 0 auto 5px auto;">
                <div>ì œí‚¤: <span id="item-ì œí‚¤">0</span>íšŒ</div>
            </div>
            <div class="item-stat-wrapper">
                <img th:src="@{/pet/ì œë‚˜.gif}" alt="ì œë‚˜ ì•„ì´ì½˜" style="width: 32px; height: 32px; display: block; margin: 0 auto 5px auto;">
                <div>ì œë‚˜: <span id="item-ì œë‚˜">0</span>íšŒ</div>
            </div>
            <div class="item-stat-wrapper">
                <img th:src="@{/pet/ì œë¦¬.gif}" alt="ì œë¦¬ ì•„ì´ì½˜" style="width: 32px; height: 32px; display: block; margin: 0 auto 5px auto;">
                <div>ì œë¦¬: <span id="item-ì œë¦¬">0</span>íšŒ</div>
            </div>
        </div>
    </div>

    <div id="result-box" class="result-box" style="margin-top: 30px;">
        ğŸ ë½‘ì€ ì•„ì´í…œ: <span id="result-item" style="font-weight: bold; color: #3498db;">-</span>
    </div>

    <div style="margin-top: 30px;">
        <button id="use-btn" class="cube-btn">1íšŒ ì‚¬ìš©</button>
        <button id="use10-btn" class="cube-btn">10íšŒ ì‚¬ìš©</button>
        <button id="reset-btn" class="cube-btn" style="background-color: #ff6b6b;">ì´ˆê¸°í™”</button>
    </div>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
    // File: src/main/resources/templates/wonder.html (JavaScript)
    const GIF_DURATION = 4000;

    // ğŸ’¡ í¬ê·€ ì•„ì´í…œ ëª©ë¡ ë° ìƒ‰ìƒ ì •ì˜
    const RARE_ITEMS = ["í¬ë¦¼", "ìƒ¤ìƒ¤", "íŒ¬ë””"];
    const RARE_COLOR = "#DAA520"; // ê³¨ë“œ ìƒ‰ìƒ
    const NORMAL_COLOR = "white"; // ì¼ë°˜ ìƒ‰ìƒ

    /**
     * ğŸ’¡ ë½‘íŒ ì•„ì´í…œì„ ì¤‘ì•™ì— í‘œì‹œí•˜ê³  ìˆœì°¨ì ì¸ ì´í™íŠ¸ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
     */
    function showDrawEffect(item) {
        if (!item || !item.name) return;

        const modal = document.getElementById("draw-effect-modal");
        const gif = document.getElementById("effect-stage1-gif");
        const revealStage = document.getElementById("effect-stage2-reveal");
        const itemNameElement = document.getElementById("effect-item-name");
        const itemImageElement = document.getElementById("effect-item-image");

        // 1. ì•„ì´í…œ ì´ë¦„ê³¼ ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •
        itemNameElement.textContent = item.name;

        // ğŸ’¡ ìƒ‰ìƒ ë™ì  ì„¤ì •
        if (RARE_ITEMS.includes(item.name)) {
            itemNameElement.style.color = RARE_COLOR;
        } else {
            itemNameElement.style.color = NORMAL_COLOR;
        }

        // ğŸš¨ ì´ë¯¸ì§€ ê²½ë¡œ ë™ì  ìƒì„±: ì•„ì´í…œ ì´ë¦„(ê³µë°± ì œê±°)ì„ ê¸°ë°˜ìœ¼ë¡œ ê²½ë¡œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        const cleanName = item.name.replace(/ /g, "");
        const imagePath = "/pet/" + cleanName + ".gif";
        itemImageElement.src = imagePath;

        // 2. ì´ˆê¸° ì„¤ì • ë° ëª¨ë‹¬ í‘œì‹œ
        revealStage.style.display = 'none';
        gif.style.display = 'block';
        modal.style.display = 'flex';

        // 3. íƒ€ì´ë¨¸ 1: GIF ì¬ìƒ í›„ ê²°ê³¼ ì´ë¯¸ì§€ í‘œì‹œ
        setTimeout(() => {
            gif.style.display = 'none';
            revealStage.style.display = 'block';
        }, GIF_DURATION);
    }

    /**
     * í†µê³„ ë° ê²°ê³¼ í™”ë©´ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
     */
    function updateStatsView(data) {
        const stats = data.statistics;
        const resultItem = data.item;

        // 1. ì´í™íŠ¸ ì¶œë ¥ (1íšŒ ì‚¬ìš© ì‹œ)
        if (resultItem) {
            showDrawEffect(resultItem);
        }

        // 2. Top Statistics Update
        document.getElementById("stat-count").textContent = stats.count;
        document.getElementById("stat-cost").textContent = stats.cost.toLocaleString('ko-KR');

        // 3. Result Item Update
        document.getElementById("result-item").textContent = resultItem ? resultItem.name : "-";

        // 4. Individual Item Counts Update
        for (const [name, count] of Object.entries(stats.itemCount)) {
            const id = "item-" + name.replace(/ /g, "");
            const element = document.getElementById(id);
            if (element) {
                element.textContent = count;
            }
        }
    }

    /**
     * í™”ë©´ í†µê³„ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ëŠ” í•¨ìˆ˜
     */
    function resetView() {
        document.getElementById("stat-count").textContent = 0;
        document.getElementById("stat-cost").textContent = 0;
        document.getElementById("result-item").textContent = "-";

        const itemIds = [
            "item-í¬ë¦¼", "item-ìƒ¤ìƒ¤", "item-íŒ¬ë””",
            "item-ê³ ë†ì¶•í”„ë¦¬ë¯¸ì—„ìƒëª…ì˜ë¬¼", "item-ì˜¤ê°€ë‹‰ì›ë”ì¿ í‚¤",
            "item-ì‹ë¹µì´", "item-ë¹µë‘˜ê¸°", "item-ì œí‚¤", "item-ì œë‚˜", "item-ì œë¦¬"
        ];

        itemIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = 0;
            }
        });
    }

    // --- Event Handlers ---

    document.getElementById("use-btn").addEventListener("click", async () => {
        const res = await fetch("/wonder/use");
        if (res.ok) {
            const data = await res.json();
            updateStatsView(data);
        } else {
            alert("1íšŒ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + res.status);
        }
    });

    document.getElementById("use10-btn").addEventListener("click", async () => {
        const res = await fetch("/wonder/use10");
        if (res.ok) {
            const data = await res.json();
            updateStatsView(data);
        } else {
            alert("10íšŒ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + res.status);
        }
    });

    document.getElementById("reset-btn").addEventListener("click", async () => {
        const res = await fetch("/wonder/reset");
        if (res.ok) {
            const data = await res.json();
            resetView();
            updateStatsView(data);
        } else {
            alert("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + res.status);
        }
    });

    // ğŸ’¡ ë‹«ê¸° ë²„íŠ¼ í•¸ë“¤ëŸ¬ (ìƒˆë¡œ ì¶”ê°€)
    document.getElementById("close-effect-btn").addEventListener("click", () => {
        document.getElementById("draw-effect-modal").style.display = 'none';
    });

    // ì´ˆê¸° ë¡œë“œ ì‹œ ë·°ë¥¼ 0ìœ¼ë¡œ ì„¤ì •
    resetView();
</script>