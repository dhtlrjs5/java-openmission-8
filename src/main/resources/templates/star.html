<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>스타포스 시뮬레이션</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<main style="text-align: center; margin-top: 50px;">
    <h2>⭐ 스타포스 강화 시뮬레이션 ⭐</h2>

    <!-- 장비 정보 -->
    <div id="equipment-info" style="margin: 30px auto; padding: 20px; border: 2px solid #ccc; border-radius: 10px; width: 400px;">
        <p>현재 별: <span id="star-count">0</span></p>
        <p>장비 가격: <span id="equipment-price">0</span> 메소</p>
        <p>누적 비용: <span id="total-cost">0</span> 메소</p>
        <p>강화 시도 횟수: <span id="attempts">0</span></p>
        <p>파괴 횟수: <span id="destruction">0</span></p>
    </div>

    <!-- 버튼 영역 -->
    <div style="margin-top: 30px;">
        <button id="enhance-btn" class="cube-btn">강화</button>
        &nbsp;&nbsp;
        <button id="repair-btn" class="cube-btn" disabled>복구</button>
        &nbsp;&nbsp;
        <button id="reset-btn" class="cube-btn">초기화</button>
    </div>

    <!-- 장비 가격 입력 -->
    <div style="margin-top: 20px;">
        <label for="set-price-input">장비 가격 설정:</label>
        <input type="number" id="set-price-input" placeholder="메소 단위">
        <button id="set-price-btn" class="cube-btn">설정</button>
    </div>
</main>

<script>
    let equipment = { level: 250, star: 0, price: 0, destroyed: false };
    window.starStatistics = { totalCost: 0, attempts: 0, destruction: 0 };

    const updateStatistics = (stats) => {
        window.starStatistics = stats ?? { totalCost: 0, attempts: 0, destruction: 0 };
    };

    const handleResponse = async (res) => {
        if (!res.ok) {
            alert(`API 오류 발생: ${res.status}`);
            return;
        }

        const responseData = await res.json();

        const resultEquipment = responseData.equipment || responseData;
        const resultStatistics = responseData.statistics || window.starStatistics;

        if (!resultEquipment || resultEquipment.star === undefined) {
            console.error("Invalid response format: equipment data missing or invalid.", responseData);
            alert("서버 응답 형식이 올바르지 않아 장비 정보를 업데이트할 수 없습니다.");
            return;
        }

        equipment.star = resultEquipment.star;
        equipment.price = resultEquipment.price;
        equipment.destroyed = resultEquipment.destroyed;

        updateStatistics(resultStatistics);
        updateView();
    };


    const updateView = () => {
        document.getElementById("star-count").textContent = equipment.star;
        document.getElementById("equipment-price").textContent = equipment.price;
        document.getElementById("total-cost").textContent = window.starStatistics.totalCost;
        document.getElementById("attempts").textContent = window.starStatistics.attempts;
        document.getElementById("destruction").textContent = window.starStatistics.destruction;

        const enhanceBtn = document.getElementById("enhance-btn");
        const repairBtn = document.getElementById("repair-btn");

        enhanceBtn.disabled = equipment.destroyed;
        repairBtn.disabled = !equipment.destroyed;

        if (equipment.destroyed) {
            enhanceBtn.classList.add('disabled');
            repairBtn.classList.remove('disabled');
        } else {
            enhanceBtn.classList.remove('disabled');
            repairBtn.classList.add('disabled');
        }
    };

    document.getElementById("set-price-btn").addEventListener("click", async () => {
        let price = Number(document.getElementById("set-price-input").value);
        if (isNaN(price) || price < 0) price = 0;
        equipment.price = price;

        const res = await fetch("/star/set-price", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(equipment)
        });

        if (!res.ok) {
            alert(`API 오류 발생: ${res.status}`);
            return;
        }

        const responseData = await res.json();
        const resultEquipment = responseData.equipment || responseData;
        const resultStatistics = responseData.statistics || window.starStatistics;

        if (!resultEquipment || resultEquipment.star === undefined) {
            console.error("Invalid set-price response format.", responseData);
            alert("가격 설정 후 서버 응답 형식이 올바르지 않습니다.");
            return;
        }

        equipment = resultEquipment;
        updateStatistics(resultStatistics);
        updateView();
    });

    document.getElementById("enhance-btn").addEventListener("click", async () => {
        const res = await fetch("/star/enhance", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(equipment)
        });
        await handleResponse(res);
    });

    document.getElementById("repair-btn").addEventListener("click", async () => {
        const res = await fetch("/star/repair", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(equipment)
        });
        await handleResponse(res);
    });

    document.getElementById("reset-btn").addEventListener("click", async () => {

        const res = await fetch("/star/reset");

        if (!res.ok) {
            alert(`서버 초기화 실패: ${res.status}`);
            return;
        }

        const responseData = await res.json();

        const resultEquipment = responseData.equipment || responseData;
        const resultStatistics = responseData.statistics || { totalCost: 0, attempts: 0, destruction: 0 };

        equipment.star = resultEquipment.star || 0;
        equipment.price = resultEquipment.price || 0;
        equipment.destroyed = resultEquipment.destroyed || false;
        equipment.level = 250; // 레벨은 하드코딩된 값으로 유지

        window.starStatistics = resultStatistics;

        updateView();
    });

    updateView();
</script>


<div th:replace="~{fragments/footer :: footer}"></div>

</body>
</html>